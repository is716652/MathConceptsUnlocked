// æ‚ æ‚ æ™ºèƒ½åŠ©æ‰‹æœåŠ¡
import { knowledgeBase, KnowledgeItem, quickReplies } from '../data/KnowledgeBase';
import { NLPUtils } from '../utils/NLPUtils';

export interface SearchResult {
  item: KnowledgeItem;
  score: number;
}

export class YouyouService {
  // æœç´¢çŸ¥è¯†åº“
  static search(query: string): SearchResult[] {
    const keywords = NLPUtils.extractMathKeywords(query);
    const category = NLPUtils.extractCategory(query);
    const results: SearchResult[] = [];
    
    for (let i = 0; i < knowledgeBase.length; i++) {
      const item = knowledgeBase[i];
      let score = 0;
      
      // æ ‡é¢˜åŒ¹é…ï¼ˆæƒé‡æœ€é«˜ï¼‰
      for (let j = 0; j < keywords.length; j++) {
        if (item.title.indexOf(keywords[j]) >= 0) {
          score = score + 20;
        }
      }
      
      // å…³é”®è¯åŒ¹é…
      for (let j = 0; j < keywords.length; j++) {
        for (let k = 0; k < item.keywords.length; k++) {
          if (item.keywords[k].indexOf(keywords[j]) >= 0 ||
              keywords[j].indexOf(item.keywords[k]) >= 0) {
            score = score + 10;
          }
        }
      }
      
      // åˆ†ç±»åŒ¹é…
      if (category.length > 0 && item.category === category) {
        score = score + 15;
      }
      
      // å†…å®¹åŒ¹é…ï¼ˆæƒé‡è¾ƒä½ï¼‰
      for (let j = 0; j < keywords.length; j++) {
        if (item.content.indexOf(keywords[j]) >= 0) {
          score = score + 5;
        }
      }
      
      if (score > 0) {
        results.push({ item: item, score: score });
      }
    }
    
    // æŒ‰åˆ†æ•°é™åºæ’åº
    results.sort((a: SearchResult, b: SearchResult) => b.score - a.score);
    return results;
  }

  // ç”Ÿæˆæ™ºèƒ½å›ç­”
  static generateAnswer(query: string): string {
    const questionType = NLPUtils.detectQuestionType(query);
    
    // å¤„ç†é—®å€™
    if (questionType === "greeting") {
      return quickReplies.greeting;
    }
    
    // å¤„ç†å¸®åŠ©è¯·æ±‚
    if (questionType === "help") {
      const helpItem = knowledgeBase.find(item => item.id === "quick_help");
      return helpItem ? helpItem.content : quickReplies.greeting;
    }
    
    // æœç´¢çŸ¥è¯†åº“
    const results = YouyouService.search(query);
    
    if (results.length === 0) {
      return quickReplies.notFound;
    }
    
    const topResult = results[0].item;
    let answer = "";
    
    // æ ¹æ®é—®é¢˜ç±»å‹ç”Ÿæˆä¸åŒå›ç­”
    if (questionType === "concept") {
      answer = `ğŸ“– **${topResult.title}**\n\n${topResult.content}`;
      
    } else if (questionType === "formula") {
      answer = `ğŸ“ **${topResult.title}**\n\n${topResult.content}`;
      
    } else if (questionType === "example") {
      answer = `ğŸ“ **${topResult.title}** çš„ä¾‹é¢˜ï¼š\n\n`;
      if (topResult.examples.length > 0) {
        for (let i = 0; i < topResult.examples.length && i < 3; i++) {
          answer = answer + `${i + 1}. ${topResult.examples[i]}\n\n`;
        }
      } else {
        answer = answer + "è¯¥çŸ¥è¯†ç‚¹æš‚æ— ä¾‹é¢˜ï¼Œä½ å¯ä»¥æŸ¥çœ‹å…¶ä»–ç›¸å…³å†…å®¹ã€‚";
      }
      
    } else if (questionType === "exercise") {
      answer = `ğŸ¯ **${topResult.title}** çš„ç»ƒä¹ é¢˜ï¼š\n\n`;
      if (topResult.exercises.length > 0) {
        for (let i = 0; i < topResult.exercises.length && i < 3; i++) {
          answer = answer + `${i + 1}. ${topResult.exercises[i]}\n\n`;
        }
      } else {
        answer = answer + "è¯¥çŸ¥è¯†ç‚¹æš‚æ— ç»ƒä¹ é¢˜ï¼Œä½ å¯ä»¥å…ˆå­¦ä¹ æ¦‚å¿µã€‚";
      }
      
    } else if (questionType === "method" || questionType === "solve") {
      answer = `ğŸ’¡ **${topResult.title}**\n\n${topResult.content}`;
      
    } else {
      // é€šç”¨å›ç­”
      answer = `å…³äº **${topResult.title}**ï¼š\n\n${topResult.content}`;
    }
    
    // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…é“¾æ¥ï¼ˆå¦‚æœæœ‰é¡µé¢ï¼‰
    if (topResult.routePage.length > 0) {
      answer = answer + `\n\nğŸ“š æŸ¥çœ‹è¯¦ç»†å†…å®¹ â†’ ${topResult.title}`;
    }
    
    // æ·»åŠ ç›¸å…³æ¨è
    if (topResult.relatedIds.length > 0) {
      answer = answer + "\n\nğŸ’¡ **ç›¸å…³çŸ¥è¯†ç‚¹**ï¼š";
      for (let i = 0; i < topResult.relatedIds.length && i < 3; i++) {
        const relatedItem = knowledgeBase.find(item => item.id === topResult.relatedIds[i]);
        if (relatedItem) {
          answer = answer + `\nâ€¢ ${relatedItem.title}`;
        }
      }
    }
    
    // å¦‚æœæœ‰å¤šä¸ªç›¸å…³ç»“æœï¼Œæç¤ºç”¨æˆ·
    if (results.length > 1) {
      answer = answer + `\n\nğŸ” è¿˜æ‰¾åˆ° ${results.length - 1} ä¸ªç›¸å…³å†…å®¹ï¼Œéœ€è¦äº†è§£å—ï¼Ÿ`;
    }
    
    return answer;
  }

  // è·å–æ¨èé—®é¢˜
  static getRecommendedQuestions(category: string): string[] {
    const questions: string[] = [];
    
    if (category === "å‡½æ•°ä¸æé™") {
      questions.push("ä»€ä¹ˆæ˜¯æé™");
      questions.push("å‡½æ•°è¿ç»­æ€§çš„å®šä¹‰");
      questions.push("é‡è¦æé™æœ‰å“ªäº›");
    } else if (category === "å¯¼æ•°ä¸å¾®åˆ†") {
      questions.push("å¯¼æ•°çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆ");
      questions.push("åŸºæœ¬æ±‚å¯¼å…¬å¼");
      questions.push("é“¾å¼æ³•åˆ™æ€ä¹ˆç”¨");
    } else if (category === "ç§¯åˆ†") {
      questions.push("ä¸å®šç§¯åˆ†çš„æ¦‚å¿µ");
      questions.push("ç§¯åˆ†å…¬å¼æœ‰å“ªäº›");
      questions.push("æ¢å…ƒæ³•æ€ä¹ˆç”¨");
    } else if (category === "å¾®åˆ†æ–¹ç¨‹") {
      questions.push("ä»€ä¹ˆæ˜¯å¾®åˆ†æ–¹ç¨‹");
      questions.push("å¯åˆ†ç¦»å˜é‡æ–¹ç¨‹");
      questions.push("ä¸€é˜¶çº¿æ€§æ–¹ç¨‹æ€ä¹ˆè§£");
    } else {
      questions.push("å¯¼æ•°æ˜¯ä»€ä¹ˆ");
      questions.push("ç»™æˆ‘ä¸€äº›ç§¯åˆ†ä¾‹é¢˜");
      questions.push("å¾®åˆ†æ–¹ç¨‹çš„ç±»å‹");
    }
    
    return questions;
  }

  // è·å–å­¦ä¹ è·¯å¾„å»ºè®®
  static getLearningPath(currentTopic: string): string[] {
    const paths: string[] = [];
    
    // æ ¹æ®å½“å‰ä¸»é¢˜æ¨èå­¦ä¹ è·¯å¾„
    const topicMap: Record<string, string[]> = {
      "æé™": ["å‡½æ•°çš„æ¦‚å¿µ", "æé™çš„æ¦‚å¿µ", "è¿ç»­æ€§", "å¯¼æ•°çš„æ¦‚å¿µ"],
      "å¯¼æ•°": ["å¯¼æ•°çš„æ¦‚å¿µ", "åŸºæœ¬æ±‚å¯¼å…¬å¼", "å¤åˆå‡½æ•°æ±‚å¯¼", "éšå‡½æ•°æ±‚å¯¼"],
      "ç§¯åˆ†": ["ä¸å®šç§¯åˆ†", "åŸºæœ¬ç§¯åˆ†å…¬å¼", "æ¢å…ƒæ³•", "åˆ†éƒ¨ç§¯åˆ†æ³•", "å®šç§¯åˆ†"],
      "çº§æ•°": ["çº§æ•°çš„æ¦‚å¿µ", "æ­£é¡¹çº§æ•°", "äº¤é”™çº§æ•°", "å¹‚çº§æ•°", "æ³°å‹’çº§æ•°"],
      "å¾®åˆ†æ–¹ç¨‹": ["å¾®åˆ†æ–¹ç¨‹æ¦‚å¿µ", "å¯åˆ†ç¦»å˜é‡", "ä¸€é˜¶çº¿æ€§", "å¸¸ç³»æ•°çº¿æ€§"]
    };
    
    // ä½¿ç”¨Object.keysæ›¿ä»£for..in
    const keys = Object.keys(topicMap);
    for (let i = 0; i < keys.length; i++) {
      const key = keys[i];
      if (currentTopic.indexOf(key) >= 0) {
        const value = topicMap[key];
        if (value) {
          return value;
        }
      }
    }
    
    return ["å‡½æ•°ä¸æé™", "å¯¼æ•°ä¸å¾®åˆ†", "ä¸å®šç§¯åˆ†", "å®šç§¯åˆ†"];
  }
}
