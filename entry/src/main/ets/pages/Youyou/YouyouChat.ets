import router from '@ohos.router';
import { YouyouService } from '../../services/YouyouService';

interface Message {
  id: number;
  type: string; // 'user' | 'youyou'
  content: string;
  timestamp: number;
}

@Entry
@Component
struct YouyouChat {
  @State messages: Message[] = [
    {
      id: 1,
      type: 'youyou',
      content: 'ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½åŠ©æ‰‹æ‚ æ‚  ðŸ¤–\n\næˆ‘å¯ä»¥å¸®ä½ ï¼š\nâ€¢ è§£ç­”æ•°å­¦æ¦‚å¿µ\nâ€¢ æŸ¥æ‰¾å…¬å¼å®šç†\nâ€¢ è®²è§£ä¾‹é¢˜\nâ€¢ æŽ¨èç»ƒä¹ é¢˜\n\nè¯•ç€é—®æˆ‘é—®é¢˜å§ï¼',
      timestamp: Date.now()
    }
  ];
  @State inputText: string = '';
  private scroller: Scroller = new Scroller();

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Button('â† è¿”å›ž')
          .fontSize(14)
          .fontColor('#3F51B5')
          .backgroundColor('#F0F0F0')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .onClick(() => router.back())

        Row() {
          Text('ðŸ¤–')
            .fontSize(32)
            .margin({ right: 8 })
          
          Column() {
            Text('æ™ºèƒ½åŠ©æ‰‹ æ‚ æ‚ ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
            Text('åœ¨çº¿')
              .fontSize(12)
              .fontColor('#4CAF50')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .margin({ left: 12 })
        
        Button('æ¸…ç©º')
          .fontSize(12)
          .fontColor('#999999')
          .backgroundColor('#F5F5F5')
          .onClick(() => {
            this.messages = [
              {
                id: 1,
                type: 'youyou',
                content: 'èŠå¤©å·²æ¸…ç©ºã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ ðŸ˜Š',
                timestamp: Date.now()
              }
            ];
          })
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 2, color: '#10000000', offsetY: 1 })

      // èŠå¤©æ¶ˆæ¯åŒº
      Scroll(this.scroller) {
        Column({ space: 12 }) {
          ForEach(this.messages, (msg: Message) => {
            if (msg.type === 'user') {
              // ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰
              Row() {
                Column() {
                  Text(msg.content)
                    .fontSize(15)
                    .fontColor('#FFFFFF')
                    .lineHeight(22)
                }
                .padding(12)
                .backgroundColor('#2196F3')
                .borderRadius({ topLeft: 12, topRight: 12, bottomLeft: 12, bottomRight: 4 })
                .constraintSize({ maxWidth: '70%' })
              }
              .width('100%')
              .justifyContent(FlexAlign.End)
              .padding({ right: 12 })
            } else {
              // æ‚ æ‚ æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰
              Row() {
                Text('ðŸ¤–')
                  .fontSize(28)
                  .margin({ right: 8, top: 4 })
                
                Column() {
                  Text(msg.content)
                    .fontSize(15)
                    .lineHeight(22)
                }
                .padding(12)
                .backgroundColor('#F5F5F5')
                .borderRadius({ topLeft: 12, topRight: 12, bottomLeft: 4, bottomRight: 12 })
                .constraintSize({ maxWidth: '70%' })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Top)
              .padding({ left: 12 })
            }
          })
        }
        .width('100%')
        .padding({ top: 12, bottom: 12 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)

      // å¿«æ·æŒ‰é’®åŒº
      Row({ space: 8 }) {
        Button('ðŸ“š æ¦‚å¿µ')
          .fontSize(13)
          .backgroundColor('#E3F2FD')
          .fontColor('#2196F3')
          .height(32)
          .onClick(() => {
            this.sendMessage('ä»€ä¹ˆæ˜¯å¯¼æ•°');
          })
        
        Button('ðŸ“ ä¾‹é¢˜')
          .fontSize(13)
          .backgroundColor('#FFF3E0')
          .fontColor('#FF9800')
          .height(32)
          .onClick(() => {
            this.sendMessage('ç»™æˆ‘ä¸€äº›ç§¯åˆ†ä¾‹é¢˜');
          })
        
        Button('ðŸŽ¯ ç»ƒä¹ ')
          .fontSize(13)
          .backgroundColor('#F3E5F5')
          .fontColor('#9C27B0')
          .height(32)
          .onClick(() => {
            this.sendMessage('æˆ‘æƒ³åšç»ƒä¹ é¢˜');
          })
        
        Button('ðŸ’¡ å¸®åŠ©')
          .fontSize(13)
          .backgroundColor('#E8F5E9')
          .fontColor('#4CAF50')
          .height(32)
          .onClick(() => {
            this.sendMessage('å¸®åŠ©');
          })
      }
      .width('100%')
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .backgroundColor('#FAFAFA')

      // åº•éƒ¨è¾“å…¥åŒº
      Row({ space: 8 }) {
        TextInput({ placeholder: 'è¾“å…¥ä½ çš„é—®é¢˜...', text: this.inputText })
          .layoutWeight(1)
          .height(40)
          .onChange((value: string) => {
            this.inputText = value;
          })
          .onSubmit(() => {
            if (this.inputText.length > 0) {
              this.sendMessage(this.inputText);
              this.inputText = '';
            }
          })
        
        Button('å‘é€')
          .fontSize(14)
          .height(40)
          .backgroundColor('#2196F3')
          .fontColor('#FFFFFF')
          .onClick(() => {
            if (this.inputText.length > 0) {
              this.sendMessage(this.inputText);
              this.inputText = '';
            }
          })
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .shadow({ radius: 2, color: '#10000000', offsetY: -1 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  sendMessage(content: string) {
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMsg: Message = {
      id: this.messages.length + 1,
      type: 'user',
      content: content,
      timestamp: Date.now()
    };
    this.messages.push(userMsg);

    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Bottom);
    }, 50);

    // æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"
    const thinkingMsg: Message = {
      id: this.messages.length + 1,
      type: 'youyou',
      content: 'æ­£åœ¨æ€è€ƒ... ðŸ¤”',
      timestamp: Date.now()
    };
    this.messages.push(thinkingMsg);

    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Bottom);
    }, 100);

    // ç”Ÿæˆå›žç­”
    setTimeout(() => {
      const answer = YouyouService.generateAnswer(content);
      
      // æ›¿æ¢æ€è€ƒæ¶ˆæ¯ä¸ºçœŸå®žå›žç­”
      this.messages.pop();
      const youyouMsg: Message = {
        id: this.messages.length + 1,
        type: 'youyou',
        content: answer,
        timestamp: Date.now()
      };
      this.messages.push(youyouMsg);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom);
      }, 50);
    }, 800);
  }
}
